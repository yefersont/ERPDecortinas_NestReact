generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Modelo de usuarios
model User {
  id       Int    @id @default(autoincrement())
  name     String
  email    String @unique
  password String @default("temporal123")
  rol      Rol    @default(USER)
}

enum Rol {
  ADMIN
  USER
}

model Clientes {
  idCliente     Int    @id @default(autoincrement())

  // CÃ©dula protegida (ISO 27001)
  cedula_hash   String @unique
  cedula_enc    Json

  nombre        String
  apellidos     String

  telefono_enc  Json?
  direccion_enc Json?

  cotizaciones  Cotizaciones[] @relation("ClienteCotizaciones")
}


model Tipo_producto {
  idTipo_producto Int                 @id @default(autoincrement())
  nombre_tp       String
  cotizaciones    DetalleCotizacion[] @relation("TipoProductoDetalles")
}

model Cotizaciones {
  idCotizacion Int      @id @default(autoincrement())
  idCliente    Int
  valor_total  Decimal
  fecha        DateTime

  cliente  Clientes            @relation("ClienteCotizaciones", fields: [idCliente], references: [idCliente])
  detalles DetalleCotizacion[] @relation("CotizacionDetalles")
  ventas   Ventas[]            @relation("CotizacionVentas")
}

model DetalleCotizacion {
  idDetalle       Int     @id @default(autoincrement())
  idCotizacion    Int
  idTipo_producto Int
  ancho           Decimal
  alto            Decimal
  precio          Decimal

  cotizacion   Cotizaciones  @relation("CotizacionDetalles", fields: [idCotizacion], references: [idCotizacion])
  tipoProducto Tipo_producto @relation("TipoProductoDetalles", fields: [idTipo_producto], references: [idTipo_producto])
}

model Ventas {
  idVenta        Int      @id @default(autoincrement())
  fecha_venta    DateTime
  idCotizacion   Int
  total          Decimal
  saldo_pendiente Decimal
  estado_pago    EstadoPago @default(PENDIENTE)

  cotizacion Cotizaciones @relation("CotizacionVentas", fields: [idCotizacion], references: [idCotizacion])
  abonos     Deudores[]
}

enum EstadoPago {
  PENDIENTE
  PAGADO
}


model Deudores {
  idDeudor    Int      @id @default(autoincrement())
  idVenta     Int
  abono       Decimal
  fecha_abono DateTime

  venta Ventas @relation(fields: [idVenta], references: [idVenta])
}
